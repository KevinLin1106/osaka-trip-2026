<script>
        // --- 1. CONFIGURATION & SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAs4eut568W2FW0zO4dU1ml-tjPbCeW_cI",
            authDomain: "osaka-trip-2026-f0e8a.firebaseapp.com",
            projectId: "osaka-trip-2026-f0e8a",
            storageBucket: "osaka-trip-2026-f0e8a.firebasestorage.app",
            messagingSenderId: "258296706242",
            appId: "1:258296706242:web:a1358012151d8767f9b75b"
        };
        
        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // ğŸ¶ Users Config with Cute Dog Icons (Icons8)
        const users = [
            { id: 'u1', name: 'å† è‰¯', avatar: 'https://img.icons8.com/color/96/shiba-inu.png' },    // æŸ´çŠ¬
            { id: 'u2', name: 'é›…å©·', avatar: 'https://img.icons8.com/color/96/corgi.png' },        // æŸ¯åŸº
            { id: 'u3', name: 'æ²›ç’‡', avatar: 'https://img.icons8.com/color/96/pug.png' },          // å·´å“¥
            { id: 'u4', name: 'å­Ÿä½³', avatar: 'https://img.icons8.com/color/96/husky.png' },        // å“ˆå£«å¥‡
            { id: 'u5', name: 'æ¤€æ·‡', avatar: 'https://img.icons8.com/color/96/beagle.png' },       // ç±³æ ¼é­¯
            { id: 'u6', name: 'ç¿å®¹', avatar: 'https://img.icons8.com/color/96/french-bulldog.png' }// æ³•é¬¥
        ];

        let currentUser = JSON.parse(localStorage.getItem('trip_current_user'));
        let currentRate = 0.22;

        // --- ğŸ”’ NEW: SECURITY CHECK (æœ€å„ªå…ˆåŸ·è¡Œ) ---
        function checkPasscode() {
            const CORRECT_CODE = 'osaka2026'; // è¨­å®šæ‚¨çš„å¯†ç¢¼
            const storedCode = localStorage.getItem('trip_passcode');

            // å¦‚æœæ›¾ç¶“è¼¸å…¥æ­£ç¢ºï¼Œå°±ç›´æ¥é€šé
            if (storedCode === CORRECT_CODE) return true;

            // å¦å‰‡è·³å‡ºè¦–çª—è©¢å•
            const input = prompt("è«‹è¼¸å…¥é€šé—œå¯†èª (æç¤º: osaka2026)");
            
            if (input === CORRECT_CODE) {
                localStorage.setItem('trip_passcode', CORRECT_CODE);
                return true;
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é å†è©¦ä¸€æ¬¡ï¼");
                // æ¸…ç©ºç•«é¢ï¼Œä¸è®“éŒ¯èª¤çš„äººçœ‹åˆ°å…§å®¹
                document.body.innerHTML = '<div style="height:100vh;display:flex;justify-content:center;align-items:center;flex-direction:column;color:#58705C;"><div>ğŸš«</div><div style="margin-top:10px;font-weight:bold;">Access Denied</div></div>';
                return false;
            }
        }

        // --- 2. LOGIN LOGIC ---
        function initLoginUI() {
            const container = document.querySelector('#loginOverlay .grid');
            container.innerHTML = '';
            
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'flex flex-col items-center gap-2';
                div.innerHTML = `
                    <button class="avatar-btn w-20 h-20 rounded-full bg-white overflow-hidden shadow-sm flex items-center justify-center" onclick="selectUser('${u.id}', this)">
                        <img src="${u.avatar}" class="w-16 h-16 object-contain">
                    </button>
                    <span class="font-bold text-gray-600 text-sm">${u.name}</span>
                `;
                container.appendChild(div);
            });

            if (currentUser) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContent').classList.remove('hidden');
                updateHeader();
                startApp();
            }
        }

        let selectedUserTemp = null;
        function selectUser(uid, btn) {
            document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedUserTemp = users.find(u => u.id === uid);
            const confirmBtn = document.getElementById('confirmLoginBtn');
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            confirmBtn.classList.add('hover:bg-jp-primary/90');
        }

        function completeLogin() {
            if (!selectedUserTemp) return;
            currentUser = selectedUserTemp;
            localStorage.setItem('trip_current_user', JSON.stringify(currentUser));
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContent').classList.remove('hidden');
            updateHeader();
            startApp();
        }

        function updateHeader() {
            document.getElementById('headerAvatar').src = currentUser.avatar;
            document.getElementById('headerName').innerText = currentUser.name;
        }

        // --- 3. APP CORE LOGIC (Listeners) ---
        function startApp() {
            // A. Listen to Shared Expenses
            db.collection('expenses').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                const list = document.getElementById('expenseList');
                list.innerHTML = '';
                if(snapshot.empty) {
                     list.innerHTML = '<div class="text-center text-gray-300 py-10">å°šç„¡è¨˜å¸³ç´€éŒ„ï¼Œå¿«ä¾†è¨˜ç¬¬ä¸€ç­†å§ï¼</div>';
                     return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const twd = Math.round(data.amount * currentRate);
                    const isMine = data.userId === currentUser.id;
                    
                    const html = `
                        <div class="bg-white p-3 rounded-xl shadow-sm flex items-center gap-3 border border-gray-100 relative group">
                            <div class="flex flex-col items-center shrink-0 w-10">
                                <img src="${data.userAvatar}" class="w-8 h-8 rounded-full border border-gray-100 bg-white object-contain p-0.5">
                                <span class="text-[9px] text-gray-400 mt-0.5">${data.userName}</span>
                            </div>
                            
                            ${data.img ? `<div class="w-12 h-12 rounded bg-gray-200 bg-cover bg-center shrink-0" style="background-image: url('${data.img}')" onclick="viewImage('${data.img}')"></div>` : ''}
                            
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-gray-800 truncate">${data.item}</div>
                                <div class="text-xs text-gray-400">Â¥${parseInt(data.amount).toLocaleString()}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-jp-primary">NT$${twd.toLocaleString()}</div>
                                <div class="text-[10px] text-gray-300">${new Date(data.timestamp).toLocaleDateString()}</div>
                            </div>
                             ${isMine ? `<button onclick="deleteExpense('${doc.id}')" class="absolute top-2 right-2 text-red-300 hover:text-red-500 opacity-20 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </div>
                    `;
                    list.innerHTML += html;
                });
            });

            // B. Listen to Public Memo
            db.collection('global').doc('public_memo').onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    // Avoid overwriting if user is typing
                    if (document.activeElement.id !== 'publicMemoInput') {
                         document.getElementById('publicMemoInput').value = data.content || '';
                    }
                }
            });

            // C. Listen to Personal Data (Private Memo & Checklist)
            db.collection('users').doc(currentUser.id).onSnapshot(doc => {
                const checklistContainer = document.getElementById('checklistContainer');
                checklistContainer.innerHTML = '';

                let myData = doc.exists ? doc.data() : { checklist: {}, customItems: [], privateMemo: '' };
                
                // 1. Render Private Memo
                if (document.activeElement.id !== 'privateMemoInput') {
                    document.getElementById('privateMemoInput').value = myData.privateMemo || '';
                    extractLinks(myData.privateMemo || '');
                }

                // 2. Render Checklist
                const defaultItems = ["è­·ç…§", "SIMå¡/ç¶²å¡", "æ—¥å¹£", "ä¿¡ç”¨å¡", "è¡Œå‹•é›»æº", "å€‹äººå¸¸å‚™è—¥", "ç‰™åˆ·ç‰™è†", "é›¨å‚˜"];
                const allItems = [...defaultItems, ...(myData.customItems || [])];
                
                allItems.forEach(item => {
                    const isChecked = myData.checklist && myData.checklist[item] ? 'checked' : '';
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-gray-50 rounded-lg">
                            <input type="checkbox" class="custom-checkbox hidden" ${isChecked} onchange="toggleCheck('${item}')">
                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center bg-white transition-colors"></div>
                            <span class="text-gray-700 group-hover:text-jp-primary transition select-none flex-1">${item}</span>
                        </label>
                    `;
                    checklistContainer.appendChild(div);
                });
            });
        }

        // --- 4. ACTION FUNCTIONS ---

        // Wallet Actions
        let tempImageBase64 = null;
        function calculate() {
             const input = document.getElementById('calcInput').value;
             try {
                if (!/^[0-9+\-*/().\s]+$/.test(input)) throw new Error();
                const jpy = eval(input);
                document.getElementById('calcResultTwd').innerText = Math.round(jpy * currentRate).toLocaleString();
             } catch(e) { document.getElementById('calcResultTwd').innerText = "Err"; }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 300;
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        tempImageBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('photoPreviewName').innerText = "ğŸ“¸ ç…§ç‰‡å·²æº–å‚™å¥½";
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function addExpense() {
            const item = document.getElementById('expenseItem').value;
            const amount = document.getElementById('expenseAmount').value;
            if(!item || !amount) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');

            const btn = document.getElementById('addExpBtn');
            const loading = document.getElementById('walletLoading');
            btn.disabled = true; loading.classList.remove('hidden');

            try {
                await db.collection('expenses').add({
                    item,
                    amount: parseFloat(amount),
                    img: tempImageBase64,
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userAvatar: currentUser.avatar, 
                    timestamp: Date.now()
                });
                
                // Reset
                document.getElementById('expenseItem').value = '';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('photoPreviewName').innerText = '';
                tempImageBase64 = null;
            } catch(e) {
                alert('ä¸Šå‚³å¤±æ•—: ' + e.message);
            } finally {
                btn.disabled = false; loading.classList.add('hidden');
            }
        }

        function deleteExpense(docId) {
            if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ')) {
                db.collection('expenses').doc(docId).delete();
            }
        }

        function viewImage(base64) {
            const w = window.open("");
            w.document.write(`<img src="${base64}" style="width:100%">`);
        }

        // Memo & List Actions
        function savePublicMemo() {
            const content = document.getElementById('publicMemoInput').value;
            db.collection('global').doc('public_memo').set({ content }, { merge: true });
        }

        function savePrivateMemo() {
            const content = document.getElementById('privateMemoInput').value;
            db.collection('users').doc(currentUser.id).set({ privateMemo: content }, { merge: true });
            extractLinks(content);
        }

        function toggleCheck(item) {
            db.collection('users').doc(currentUser.id).get().then(doc => {
                let data = doc.data() || {};
                let checklist = data.checklist || {};
                checklist[item] = !checklist[item];
                db.collection('users').doc(currentUser.id).set({ checklist }, { merge: true });
            });
        }

        function addCustomCheckitem() {
            const newItem = prompt("è«‹è¼¸å…¥æƒ³æ–°å¢çš„ç‰©å“åç¨±ï¼š");
            if(newItem) {
                db.collection('users').doc(currentUser.id).set({
                    customItems: firebase.firestore.FieldValue.arrayUnion(newItem)
                }, { merge: true });
            }
        }

        function extractLinks(text) {
            const container = document.getElementById('memoLinks');
            container.innerHTML = '';
            const matches = text.match(/(https?:\/\/[^\s]+)/g);
            if (matches) {
                matches.forEach(url => {
                    const a = document.createElement('a');
                    a.href = url; a.target = '_blank';
                    a.className = 'text-xs bg-jp-secondary/30 text-jp-text px-2 py-1 rounded truncate inline-block border border-jp-secondary mr-2 mb-2';
                    a.innerHTML = `<i class="fa-solid fa-link mr-1"></i> é€£çµ`;
                    container.appendChild(a);
                });
            }
        }

        // Navigation
        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-jp-primary'); el.classList.add('text-gray-400');
            });
            const indexMap = { 'plan':0, 'guide':1, 'wallet':2, 'lists':3, 'info':4 };
            const btns = document.querySelectorAll('.nav-btn');
            btns[indexMap[tabId]].classList.remove('text-gray-400');
            btns[indexMap[tabId]].classList.add('text-jp-primary');
            window.scrollTo(0,0);
        }

        // --- 5. INITIALIZATION (é€™è£¡æœ€é—œéµï¼) ---
        // åªæœ‰åœ¨é€šéå¯†ç¢¼æª¢æŸ¥å¾Œï¼Œæ‰åŸ·è¡Œ initLoginUI
        if (checkPasscode()) {
            initLoginUI();
        }

    </script>